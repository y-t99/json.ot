# json.ot
The `json0` typescript version

## Notion

### Snapshot

Snapshots represents the data structure of a document, which can be understood as a string in `Text OT Type`, or can be understood as JSON in `JSON OT Type`. Snapshots are generated by applying a series of operations.

### Operation

Operations represent modifications to a document, similar to the diff between two commits in Git operations. An operation includes multiple actions. An action is an atomic operation on a document.

## Text OT Type

### Action

Operation                              | Description
---------------------------------------|-------------------------------------
`{n: 'SI', p: number, i: string}`      | inserts the string `i` at offset `p` into the string 
`{n: 'SD', p: number, d: string}`      | deletes the string `d` at offset `p` from the string 

### Method

#### apply(snapshot, operation)

Applying an operation to a snapshot:

```typescript

const operation: ITOTAction[] = [
  {
    n: TOTActionName.StringInsert,
    p: 0,
    i: 'hello',
  },
];
const result = tot.apply(' world', operation);
expect(result).toEqual('hello world');
```

#### compose(operationA, operationB)

Merging operations which have a linear relationship:

```typescript
const snapshot = 'AD';
const operationA: ITOTAction[] = [{
  n: TOTActionName.StringInsert,
  p: 1,
  i: 'B',
}];
const operationB: ITOTAction[] = [{
  n: TOTActionName.StringInsert,
  p: 2,
  i: 'C',
}];
const snapshotA = tot.apply(tot.apply(snapshot, operationA), operationB);
const snapshotB = tot.apply(snapshot, tot.compose(operationA, operationB));
expect(snapshotA === snapshotB).toBeTruthy();
```

#### invert(operation)

Inverting an action generates the inverse operation of an operation:

```typescript
const operation: ITOTAction[] = [
  {
    n: TOTActionName.StringInsert,
    p: 0,
    i: 'abc',
  }
];
const reversalAction = tot.invert(operation);
expect(reversalAction[0].n).toEqual(TOTActionName.StringDelete);
expect(reversalAction[0].p).toEqual(0);
expect((reversalAction[0] as IStringDeleteAction).d).toEqual('abc');
```

#### transform(operation, otherOperation)

A document is generated by operations, and when multiple people collaborate on the document, it is necessary to transform these operations to ensure the consistency of the final document:

```typescript
// if init document equals to ' ';
const operation: ITOTAction[] = [
  {
    n: TOTActionName.StringInsert,
    p: 1,
    i: 'world',
  },
];
const otherOperation: ITOTAction[] = [
  {
    n: TOTActionName.StringInsert,
    p: 0,
    i: 'hello',
  },
];
const transformOperation = tot.transform(
  operation,
  otherOperation,
  'right'
);
expect(transformOperation[0].p).toEqual(6);
```

#### transformX(operationA, operationB)

When two people collaborate on the same snapshot, they can generate derivative operations for their operations using transformX. The non-linear snapshot applies the derived operations, and the different snapshots converges to the same state: 

```typescript
const snapshot = 'AF';
const serverOperation: ITOTAction[] = [
  {
    n: TOTActionName.StringInsert,
    p: 1,
    i: 'B',
  },
  {
    n: TOTActionName.StringInsert,
    p: 2,
    i: 'C',
  },
];
const clientOperation: ITOTAction[] = [
  {
    n: TOTActionName.StringInsert,
    p: 1,
    i: 'D',
  },
  {
    n: TOTActionName.StringInsert,
    p: 2,
    i: 'E',
  },
];
const serverSnapshot = tot.apply(snapshot, serverOperation);
const clientSnapshot = tot.apply(snapshot, clientOperation);
const [leftOperation, rightOperation] = tot.transformX(
  serverOperation,
  clientOperation,
);
const client = tot.apply(clientSnapshot, leftOperation);
const service = tot.apply(serverSnapshot, rightOperation);
expect(client).toEqual('ABCDEF');
expect(client).toEqual(service);
```